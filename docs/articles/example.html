<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>example • afsclls</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js" integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g==" crossorigin="anonymous" referrerpolicy="no-referrer"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="example">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">


    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">afsclls</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">0.1.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Articles

    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/example.html">example</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right"></ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->



      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>example</h1>
            
      

      <div class="hidden name"><code>example.Rmd</code></div>

    </div>

    
    
<p>Step 1. get access to the server, if you send something like this
along to the IT helpdesk they will know what to do (access will need to
be approved by the database holder - currently Pat):</p>
<blockquote>
<p>Could I please be provided access to: “Driver={SQL Server};
server=161.55.120.71,1919; database=LONGLINE;</p>
</blockquote>
<p>once provided with access the below code should work</p>
<p><em>notes:</em> <em>this data pull does not do any filtering (other
than year for the example)</em> <em>filtering/corrections are done
during the next steps</em></p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># load ----</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">afsclls</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># globals ----</span></span>
<span><span class="va">year</span> <span class="op">=</span> <span class="fl">2022</span></span>
<span></span>
<span><span class="co"># call data </span></span>
<span><span class="va">db</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/connect.html">connect</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">catch_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/q_catch.html">q_catch</a></span><span class="op">(</span><span class="va">year</span>, <span class="va">db</span><span class="op">)</span></span>
<span><span class="va">length_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/q_lengths.html">q_lengths</a></span><span class="op">(</span><span class="va">year</span>, <span class="va">db</span><span class="op">)</span></span>
<span><span class="va">strata_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/q_strata.html">q_strata</a></span><span class="op">(</span><span class="va">db</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/disconnect.html">disconnect</a></span><span class="op">(</span><span class="va">db</span><span class="op">)</span></span></code></pre></div>
<p>The next step is to calculate the mean weights from von Bertalanffy
parameters and clean up a few items.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">length_data</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu">tidytable</span><span class="fu">::</span><span class="fu"><a href="https://markfairbanks.github.io/tidytable/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>unit_wt <span class="op">=</span> <span class="va">a_vonbert</span> <span class="op">*</span> <span class="va">length</span><span class="op">^</span><span class="va">b_vonbert</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="co"># flag - wt is based upon single growth period</span></span>
<span>  <span class="fu">tidytable</span><span class="fu">::</span><span class="fu"><a href="https://markfairbanks.github.io/tidytable/reference/summarize.html" class="external-link">summarise</a></span><span class="op">(</span>total_freq <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">frequency</span><span class="op">)</span>,</span>
<span>                        len_freq <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">length</span> <span class="op">*</span> <span class="va">frequency</span><span class="op">)</span>,</span>
<span>                        wt_freq <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">unit_wt</span> <span class="op">*</span> <span class="va">frequency</span>, na.rm<span class="op">=</span><span class="cn">T</span><span class="op">)</span>,</span>
<span>                        .by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">cruise_station_id</span>, <span class="va">depth_stratum_id</span>, <span class="va">species_code</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu">tidytable</span><span class="fu">::</span><span class="fu"><a href="https://markfairbanks.github.io/tidytable/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>mean_len <span class="op">=</span> <span class="va">len_freq</span> <span class="op">/</span> <span class="va">total_freq</span>,</span>
<span>                    mean_wt <span class="op">=</span> <span class="va">wt_freq</span> <span class="op">/</span> <span class="va">total_freq</span>, </span>
<span>                    .by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">cruise_station_id</span>, <span class="va">depth_stratum_id</span>, <span class="va">species_code</span><span class="op">)</span><span class="op">)</span> <span class="op">-&gt;</span> <span class="va">mean_wts</span></span></code></pre></div>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># change null ineffective to 0  </span></span>
<span><span class="co"># drop ineffective skates &gt; 5 hooks, filter to just important species</span></span>
<span><span class="co"># change mammal sighting to 0/1</span></span>
<span><span class="co"># if depredation is present add in multiplier and se</span></span>
<span><span class="co"># REVIEW: split out REBS shortraker 30576; rougheye 30050 (group code 30051 post-1997, 30040 pre-1998)</span></span>
<span><span class="co"># TODO: split out Kamchatka/arrowtooth ...</span></span>
<span><span class="co"># expand total catch - adjust for ineffective hooks to 45 hooks and total skates, and whale dep for sablefish</span></span>
<span><span class="va">catch_data</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> </span>
<span>    <span class="fu">tidytable</span><span class="fu">::</span><span class="fu"><a href="https://markfairbanks.github.io/tidytable/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>mammal_sighting <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html" class="external-link">ifelse</a></span><span class="op">(</span><span class="va">mammal_sighting</span><span class="op">==</span><span class="st">'S'</span>, <span class="fl">1</span>, <span class="fl">0</span><span class="op">)</span>,</span>
<span>                    wcfd <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html" class="external-link">ifelse</a></span><span class="op">(</span><span class="va">depredation_flag</span><span class="op">==</span><span class="fl">1</span>, <span class="fl">1.176471</span>, <span class="fl">1.0</span><span class="op">)</span>,</span>
<span>                    wcfd_se <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html" class="external-link">ifelse</a></span><span class="op">(</span><span class="va">depredation_flag</span><span class="op">==</span><span class="fl">1</span>, <span class="fl">0.2070316</span>, <span class="fl">0.0</span><span class="op">)</span>,</span>
<span>                    <span class="co"># species_code = tidytable::case_when(species_code %in% c(30040, 30051) ~ 30050,</span></span>
<span>                    <span class="co">#                                                         TRUE ~ species_code)</span></span>
<span>                    <span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu">tidytable</span><span class="fu">::</span><span class="fu"><a href="https://markfairbanks.github.io/tidytable/reference/replace_na.html" class="external-link">replace_na</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>ineffective <span class="op">=</span> <span class="fl">0</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu">tidytable</span><span class="fu">::</span><span class="fu"><a href="https://markfairbanks.github.io/tidytable/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">ineffective</span> <span class="op">&lt;=</span> <span class="fl">5</span>, <span class="co"># flag - removing ineffective sets</span></span>
<span>                    <span class="va">species_code</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">310</span>,<span class="fl">320</span>,<span class="fl">440</span>,<span class="fl">455</span>,<span class="fl">475</span>,<span class="fl">480</span>,<span class="fl">10110</span>,<span class="fl">10112</span>,<span class="fl">10115</span>,<span class="fl">10120</span>,<span class="fl">20510</span>,</span>
<span>                                        <span class="fl">21220</span>,<span class="fl">21230</span>,<span class="fl">21720</span>,<span class="fl">30020</span>,<span class="fl">30050</span>,<span class="fl">30470</span>,<span class="fl">30576</span>,<span class="fl">99995</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">tidytable</span><span class="fu">::</span><span class="fu"><a href="https://markfairbanks.github.io/tidytable/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>adj_freq <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">catch_freq</span> <span class="op">/</span> <span class="op">(</span><span class="fl">45</span> <span class="op">-</span> <span class="va">ineffective</span><span class="op">)</span> <span class="op">*</span> <span class="fl">45</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>, </span>
<span>                    .by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">cruise_station_id</span>, <span class="va">hachi</span>, <span class="va">species_code</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu">tidytable</span><span class="fu">::</span><span class="fu"><a href="https://markfairbanks.github.io/tidytable/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>adj_catch_dep <span class="op">=</span> </span>
<span>                      <span class="fu">tidytable</span><span class="fu">::</span><span class="fu"><a href="https://markfairbanks.github.io/tidytable/reference/case_when.html" class="external-link">case_when</a></span><span class="op">(</span><span class="va">depredation_flag</span><span class="op">==</span><span class="fl">1</span> <span class="op">&amp;</span> <span class="va">species_code</span><span class="op">==</span><span class="fl">20510</span> <span class="op">~</span> <span class="va">wcfd</span> <span class="op">*</span> <span class="va">adj_freq</span>,</span>
<span>                                                         <span class="va">depredation_flag</span><span class="op">==</span><span class="fl">0</span> <span class="op">&amp;</span> <span class="va">species_code</span><span class="op">==</span><span class="fl">20510</span> <span class="op">&amp;</span> </span>
<span>                                                           <span class="va">mammal_sighting</span><span class="op">==</span><span class="fl">1</span> <span class="op">~</span> <span class="va">wcfd</span> <span class="op">*</span> <span class="va">adj_freq</span>, </span>
<span>                                                         <span class="cn">TRUE</span> <span class="op">~</span> <span class="va">catch_freq</span><span class="op">)</span>,</span>
<span>                    adj_catch <span class="op">=</span> <span class="va">catch_freq</span> <span class="op">*</span> <span class="va">adj_freq</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu">tidytable</span><span class="fu">::</span><span class="fu"><a href="https://markfairbanks.github.io/tidytable/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>n_hachi <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">catch_freq</span><span class="op">)</span>, .by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">cruise_station_id</span>, <span class="va">hachi</span>, <span class="va">species_code</span><span class="op">)</span><span class="op">)</span> <span class="op">-&gt;</span> <span class="va">dat1</span></span>
<span></span>
<span><span class="va">dat1</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu">tidytable</span><span class="fu">::</span><span class="fu"><a href="https://markfairbanks.github.io/tidytable/reference/summarize.html" class="external-link">summarise</a></span><span class="op">(</span>total_catch <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">adj_catch</span><span class="op">)</span>, </span>
<span>                       total_skates <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">n_hachi</span><span class="op">)</span>,</span>
<span>                       .by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">cruise_station_id</span>, <span class="va">stratum2</span>, <span class="va">species_code</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu">tidytable</span><span class="fu">::</span><span class="fu"><a href="https://markfairbanks.github.io/tidytable/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>cpue <span class="op">=</span> <span class="va">total_catch</span> <span class="op">/</span> <span class="va">total_skates</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html" class="external-link">left_join</a></span><span class="op">(</span><span class="va">length_data</span><span class="op">)</span></span></code></pre></div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

      </div>

</div>



      <footer><div class="copyright">
  <p></p>
<p>Developed by Ben Williams.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.1.</p>
</div>

      </footer>
</div>






  </body>
</html>
